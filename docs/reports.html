<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarlang Reports & Suggestions</title>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Config -->
    <script src="js/config.js"></script>
    
    <link rel="stylesheet" href="css/jarlang-common.css">
    <style>
        /* Page-specific styles */
        .reports-list {
            margin-top: 32px;
        }
        .report-item {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            transition: box-shadow 0.2s;
        }
        .report-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .report-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 12px;
        }
        .report-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .report-type.bug {
            background: #fee;
            color: #c53030;
        }
        .report-type.feature {
            background: #e6fffa;
            color: #234e52;
        }
        .report-type.improvement {
            background: #fef5e7;
            color: #744210;
        }
        .report-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin: 8px 0;
        }
        .report-meta {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 12px;
        }
        .report-description {
            color: #555;
            line-height: 1.5;
        }
        .report-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e1e5e9;
            display: flex;
            gap: 8px;
        }
        .report-flagged {
            opacity: 0.6;
            background: #fff5f5;
            border: 1px solid #fed7d7;
        }
        .report-flagged .report-title::after {
            content: " [FLAGGED]";
            color: #c53030;
            font-size: 0.8em;
            font-weight: normal;
        }
        .report-hidden {
            display: none;
        }
        .moderation-notice {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            color: #92400e;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="syntax.html">Syntax</a>
        <a href="stdlib.html">Standard Library</a>
        <a href="testlib.html">Test Library</a>
        <a href="index.html">How-To Guide</a>
        <a href="story.html">Story of Jarlang</a>
        <a href="reports.html">Reports & Suggestions</a>
        <a href="downloads.html">Downloads</a>
    </nav>

    <div id="app">
        <div class="container">
            <aside class="sidebar">
                <h3>Quick Actions</h3>
                <ul>
                    <li><a href="#submit-report">Submit Report</a></li>
                    <li><a href="#view-reports">View Reports</a></li>
                    <li><a href="#feature-requests">Feature Requests</a></li>
                    <li><a href="#bug-reports">Bug Reports</a></li>
                </ul>
            </aside>

            <main class="main-content">
                <div class="page-header">
                    <h1>üõ°Ô∏è Reports & Suggestions</h1>
                    <img src="jarlang_resources/jarknight_final_glaze.png" alt="JarKnight Mascot" class="mascot-img" />
                </div>

                    <div v-if="!supabaseConfigured" class="alert alert-error">
                        <strong>‚ö†Ô∏è Demo Mode:</strong> Supabase is not configured. Reports won't be saved. 
                        <a href="QUICK_SETUP.md" style="color: #721c24; text-decoration: underline;">See setup guide</a>
                    </div>
                    
                    <div v-if="alert.show" :class="['alert', alert.type]">
                        {{ alert.message }}
                    </div>

                <section class="form-section" id="submit-report">
                    <h2>Submit a Report or Suggestion</h2>
                    <p>Help improve Jarlang by reporting bugs, suggesting features, or sharing ideas!</p>
                    
                    <form @submit.prevent="submitReport">
                        <div class="form-group">
                            <label for="type">Report Type</label>
                            <select v-model="form.type" id="type" required>
                                <option value="">Select type...</option>
                                <option value="bug">üêõ Bug Report</option>
                                <option value="feature">‚ú® Feature Request</option>
                                <option value="improvement">üöÄ Improvement Suggestion</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="title">Title</label>
                            <input 
                                v-model="form.title" 
                                type="text" 
                                id="title" 
                                placeholder="Brief description of the issue or suggestion"
                                required
                                maxlength="100"
                            />
                        </div>

                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea 
                                v-model="form.description" 
                                id="description" 
                                placeholder="Provide detailed information about the bug, feature request, or improvement..."
                                required
                                maxlength="1000"
                            ></textarea>
                        </div>

                        <div class="form-group">
                            <label for="contact">Email (Optional)</label>
                            <input 
                                v-model="form.contact" 
                                type="email" 
                                id="contact" 
                                placeholder="your.email@example.com (for follow-up)"
                            />
                        </div>

                        <button type="submit" class="btn" :disabled="submitting">
                            {{ submitting ? 'Submitting...' : 'Submit Report' }}
                        </button>
                    </form>
                </section>

                <section class="reports-list" id="view-reports">
                    <h2>Recent Reports & Suggestions</h2>
                    
                    <div v-if="flaggedCount > 0" class="moderation-notice">
                        <strong>‚ö†Ô∏è Content Moderation:</strong> {{ flaggedCount }} report(s) have been flagged and are hidden pending review.
                    </div>
                    
                    <div v-if="loading" class="loading">
                        Loading reports...
                    </div>
                    
                    <div v-else-if="!supabaseConfigured" class="loading">
                        <strong>Demo Mode:</strong> Configure Supabase to see and save reports.
                        <br><a href="QUICK_SETUP.md" style="color: #667eea;">View setup guide ‚Üí</a>
                    </div>
                    
                    <div v-else-if="visibleReports.length === 0" class="loading">
                        {{ reports.length === 0 ? 'No reports yet. Be the first to contribute!' : 'All reports are currently under review.' }}
                    </div>
                    
                    <div v-else>
                        <div v-for="report in visibleReports" :key="report.id" 
                             :class="['report-item', { 'report-flagged': report.flagged }]">
                            <div class="report-header">
                                <span :class="['report-type', report.type]">{{ report.type }}</span>
                            </div>
                            <div class="report-title">{{ report.title }}</div>
                            <div class="report-meta">
                                Submitted {{ formatDate(report.created_at) }}
                            </div>
                            <div class="report-description">{{ report.description }}</div>
                            <div class="report-actions">
                                <button v-if="!report.flagged" 
                                        @click="flagReport(report)" 
                                        class="btn-small danger"
                                        :disabled="report.flagging">
                                    {{ report.flagging ? 'Flagging...' : 'üö© Flag as Inappropriate' }}
                                </button>
                                <span v-if="report.flagged" class="btn-small" style="color: #c53030;">
                                    ‚ö†Ô∏è Flagged for Review
                                </span>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        // Initialize Supabase using config
        const supabaseClient = window.supabaseConfig.getSupabaseClient();
        const supabaseConfigured = window.supabaseConfig.isConfigured();
        
        // Log environment info
        window.supabaseConfig.logEnvironment();

        createApp({
            data() {
                return {
                    form: {
                        type: '',
                        title: '',
                        description: '',
                        contact: ''
                    },
                    reports: [],
                    loading: false,
                    submitting: false,
                    supabaseConfigured: supabaseConfigured,
                    alert: {
                        show: false,
                        type: '',
                        message: ''
                    }
                };
            },
            computed: {
                visibleReports() {
                    return this.reports.filter(report => !report.flagged || report.status === 'approved');
                },
                flaggedCount() {
                    return this.reports.filter(report => report.flagged && report.status !== 'approved').length;
                }
            },
            async mounted() {
                await this.loadReports();
            },
            methods: {
                async submitReport() {
                    this.submitting = true;
                    this.hideAlert();

                    // Demo mode - simulate submission without Supabase
                    if (!supabaseClient) {
                        setTimeout(() => {
                            this.showAlert('success', 'Demo: Report would be saved (Supabase not configured)');
                            const demoReport = {
                                id: Date.now(),
                                type: this.form.type,
                                title: this.form.title,
                                description: this.form.description,
                                contact: this.form.contact || null,
                                created_at: new Date().toISOString()
                            };
                            this.reports.unshift(demoReport);
                            this.resetForm();
                            this.submitting = false;
                        }, 1000);
                        return;
                    }

                    try {
                        const { data, error } = await supabaseClient
                            .from('jarlang_reports')
                            .insert([
                                {
                                    type: this.form.type,
                                    title: this.form.title,
                                    description: this.form.description,
                                    contact: this.form.contact || null,
                                    created_at: new Date().toISOString()
                                }
                            ]);

                        if (error) throw error;

                        this.showAlert('success', 'Thank you! Your report has been submitted successfully.');
                        this.resetForm();
                        await this.loadReports();
                    } catch (error) {
                        console.error('Error submitting report:', error);
                        this.showAlert('error', 'Sorry, there was an error submitting your report. Please try again.');
                    } finally {
                        this.submitting = false;
                    }
                },
                
                async loadReports() {
                    this.loading = true;
                    
                    // Demo mode - show sample data
                    if (!supabaseClient) {
                        setTimeout(() => {
                            this.reports = [
                                {
                                    id: 1,
                                    type: 'feature',
                                    title: 'Add for loop syntax',
                                    description: 'It would be great to have a more traditional for loop syntax in addition to the while loop.',
                                    created_at: new Date(Date.now() - 86400000).toISOString() // 1 day ago
                                },
                                {
                                    id: 2,
                                    type: 'bug',
                                    title: 'Error with nested function calls',
                                    description: 'When calling functions inside other functions, I get an unexpected parsing error.',
                                    created_at: new Date(Date.now() - 172800000).toISOString() // 2 days ago
                                },
                                {
                                    id: 3,
                                    type: 'improvement',
                                    title: 'Better error messages',
                                    description: 'Error messages could be more descriptive to help with debugging.',
                                    created_at: new Date(Date.now() - 259200000).toISOString() // 3 days ago
                                }
                            ];
                            this.loading = false;
                        }, 500);
                        return;
                    }
                    
                    try {
                        const { data, error } = await supabaseClient
                            .from('jarlang_reports')
                            .select('*')
                            .or('flagged.eq.false,status.eq.approved') // Only show non-flagged or approved reports
                            .order('created_at', { ascending: false })
                            .limit(20);

                        if (error) throw error;
                        
                        this.reports = data || [];
                    } catch (error) {
                        console.error('Error loading reports:', error);
                        this.showAlert('error', 'Could not load reports. Please refresh the page.');
                    } finally {
                        this.loading = false;
                    }
                },
                
                resetForm() {
                    this.form = {
                        type: '',
                        title: '',
                        description: '',
                        contact: ''
                    };
                },
                
                async flagReport(report) {
                    console.log('flagReport called with:', report);
                    
                    // Set loading state for this specific report
                    report.flagging = true;
                    console.log('Set flagging to true, report.flagging is now:', report.flagging);
                    
                    // Demo mode - simulate flagging
                    if (!supabaseClient) {
                        setTimeout(() => {
                            // Remove the report from display in demo mode too
                            const reportIndex = this.reports.findIndex(r => r.id === report.id);
                            if (reportIndex !== -1) {
                                this.reports.splice(reportIndex, 1);
                            }
                            report.flagging = false;
                            this.showAlert('success', 'Demo: Report flagged for review and hidden (Supabase not configured)');
                        }, 1000);
                        return;
                    }
                    
                    try {
                        console.log('Flagging report:', report.id);
                        const { data, error } = await supabaseClient
                            .from('jarlang_reports')
                            .update({ 
                                flagged: true, 
                                status: 'pending_review',
                                flagged_at: new Date().toISOString()
                            })
                            .eq('id', report.id)
                            .select();
                            
                        if (error) {
                            console.error('Supabase error:', error);
                            throw error;
                        }
                        
                        console.log('Update successful:', data);
                        
                        // Remove the flagged report from the local display since it's now pending review
                        const reportIndex = this.reports.findIndex(r => r.id === report.id);
                        if (reportIndex !== -1) {
                            this.reports.splice(reportIndex, 1);
                        }
                        
                        this.showAlert('success', 'Report flagged for review and hidden from public view. Thank you for helping maintain content quality.');
                        
                    } catch (error) {
                        console.error('Error flagging report:', error);
                        this.showAlert('error', `Could not flag report: ${error.message || 'Unknown error'}`);
                    } finally {
                        report.flagging = false;
                    }
                },
                
                showAlert(type, message) {
                    this.alert = {
                        show: true,
                        type: type === 'success' ? 'alert-success' : 'alert-error',
                        message
                    };
                    
                    setTimeout(() => {
                        this.hideAlert();
                    }, 5000);
                },
                
                hideAlert() {
                    this.alert.show = false;
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString() + ' at ' + date.toLocaleTimeString();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>